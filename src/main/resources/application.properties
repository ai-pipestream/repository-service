# Repository Service Configuration
quarkus.application.name=repository-service
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Repository service port (38102)
quarkus.http.host=0.0.0.0
quarkus.http.port=38102
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# gRPC Flow Control - 50MB window for large messages
quarkus.grpc.server.flow-control-window=52428800

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800

# Dev configuration
%dev.quarkus.http.port=38102
%dev.quarkus.http.root-path=/repository

# Test configuration
%test.quarkus.http.test-port=0

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=mysql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use MySQL dev service (port 3306)
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline_repository_dev

# Hibernate configuration
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true

# Test: Clean database and let Hibernate create schema
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

%dev.quarkus.devservices.timeout=120s

# Test profile - use compose dev services with MySQL
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s

# Test datasource - MySQL from compose
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3307/pipeline_repository_test

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
%test.pipestream.registration.enabled=false
pipestream.registration.service-name=repository-service
pipestream.registration.description=Central repository management for documents, modules, and configurations
pipestream.registration.type=SERVICE
pipestream.registration.advertised-host=${SERVICE_REGISTRATION_ADVERTISED_HOST:host.docker.internal}
pipestream.registration.advertised-port=${quarkus.grpc.server.port:${quarkus.http.port}}
pipestream.registration.internal-host=${SERVICE_REGISTRATION_INTERNAL_HOST:172.17.0.1}
pipestream.registration.internal-port=${quarkus.grpc.server.port:${quarkus.http.port}}
pipestream.registration.capabilities=document-storage,version-control,metadata-management
pipestream.registration.tags=repository,storage,core-service,traefik.enable=true,traefik.http.routers.repository-service.rule=PathPrefix(`/repository`),traefik.http.routers.repository-service.entrypoints=web,traefik.http.middlewares.repository-slash.redirectregex.regex=^/repository$$,traefik.http.middlewares.repository-slash.redirectregex.replacement=/repository/,traefik.http.routers.repository-service.middlewares=repository-slash

# Registration service connection (platform-registration-service)
pipestream.registration.registration-service.host=localhost
pipestream.registration.registration-service.port=38101

# Stork Consul Self-Registration
quarkus.stork.repository-service.service-registrar.type=consul
quarkus.stork.repository-service.service-registrar.consul-host=${CONSUL_HOST:consul}
quarkus.stork.repository-service.service-registrar.consul-port=${CONSUL_PORT:8500}
%dev.quarkus.stork.repository-service.service-registrar.consul-host=localhost

# Dynamic gRPC Service Discovery
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}
rokkon.service-discovery.type=consul-direct

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry configuration
mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

# ======================================================================================================================
# S3 / MinIO Configuration (repo-service only)
# ======================================================================================================================
# Disable AWS dev services (LocalStack) - we use MinIO from compose-devservices.yml
%dev.quarkus.amazon-services.devservices.enabled=false
%test.quarkus.amazon-services.devservices.enabled=false

repo.s3.endpoint=${REPO_S3_ENDPOINT:http://localhost:9000}
repo.s3.region=${REPO_S3_REGION:us-east-1}
repo.s3.access-key=${REPO_S3_ACCESS_KEY:minioadmin}
repo.s3.secret-key=${REPO_S3_SECRET_KEY:minioadmin}
repo.s3.bucket=${REPO_S3_BUCKET:pipestream}
repo.s3.path-style-access=${REPO_S3_PATH_STYLE_ACCESS:true}
repo.s3.key-prefix=${REPO_S3_KEY_PREFIX:uploads}

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."io.pipeline".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# ======================================================================================================================
# Phase 1 Intake Service Configuration (Fast ACK Pattern)
# ======================================================================================================================
# Feature gate - enable Phase 1 intake-only fast ACK path
repo.features.phase1.enabled=true
%test.repo.features.phase1.enabled=true

# In-memory state caps
repo.intake.memory.max-uploads=50000
repo.intake.memory.idle-ttl=PT30M

# Progress stream interval
repo.intake.progress.interval=PT0.5S

# Checksum validation (off for Phase 1)
repo.intake.checksum.validate=false

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=repository-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.grpc-stubs.group-id=io.pipeline
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=io.pipeline
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc
quarkus.index-dependency.pipestream-registration.group-id=ai.pipestream
quarkus.index-dependency.pipestream-registration.artifact-id=pipestream-service-registration
quarkus.index-dependency.pipestream-dynamic-grpc.group-id=ai.pipestream
quarkus.index-dependency.pipestream-dynamic-grpc.artifact-id=quarkus-dynamic-grpc
