# Repository Service Configuration
quarkus.application.name=repository-service
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Repository service port (38105)
quarkus.http.host=0.0.0.0
quarkus.http.port=38105
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# gRPC Flow Control - 50MB window for large messages
quarkus.grpc.server.flow-control-window=52428800

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800

# Dev configuration
%dev.quarkus.http.port=38105
%dev.quarkus.http.root-path=/repository

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.datasource.devservices.enabled=false
%test.quarkus.datasource.db-kind=h2
%test.quarkus.datasource.jdbc.url=jdbc:h2:mem:test

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=mysql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use MySQL dev service (port 3306)
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline_repository_dev

# Hibernate configuration
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true

# Test: Clean database and let Hibernate create schema
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Redis Configuration
# ======================================================================================================================
quarkus.redis.hosts=redis://localhost:6379
%dev.quarkus.redis.hosts=redis://localhost:6379

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

%dev.quarkus.devservices.timeout=120s

# Test profile - disable compose dev services for Phase 1 (in-memory only)
%test.quarkus.devservices.enabled=false
%test.quarkus.compose.devservices.enabled=false

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
%test.service.registration.enabled=false
service.registration.service-name=repository-service
service.registration.description=Central repository management for documents, modules, and configurations
service.registration.service-type=APPLICATION
service.registration.host=${REPOSITORY_SERVICE_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
service.registration.capabilities=document-storage,version-control,metadata-management
service.registration.tags=repository,storage,core-service,traefik.enable=true,traefik.http.routers.repository-service.rule=PathPrefix(`/repository`),traefik.http.routers.repository-service.entrypoints=web,traefik.http.middlewares.repository-slash.redirectregex.regex=^/repository$$,traefik.http.middlewares.repository-slash.redirectregex.replacement=/repository/,traefik.http.routers.repository-service.middlewares=repository-slash

# Stork Consul Self-Registration (disabled for test)
quarkus.stork.repository-service.service-registrar.type=consul
quarkus.stork.repository-service.service-registrar.consul-host=${CONSUL_HOST:consul}
quarkus.stork.repository-service.service-registrar.consul-port=${CONSUL_PORT:8500}
%dev.quarkus.stork.repository-service.service-registrar.consul-host=localhost

# Dynamic gRPC Service Discovery
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}
rokkon.service-discovery.type=consul-direct

# gRPC Service Registration
service.registration.grpc.enabled=true
service.registration.grpc.port=${quarkus.grpc.server.port:${quarkus.http.port}}

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry configuration
mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."io.pipeline".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN

# Health checks
quarkus.smallrye-health.root-path=/q/health
quarkus.smallrye-health.liveness-path=/q/health/live
quarkus.smallrye-health.readiness-path=/q/health/ready

# ======================================================================================================================
# Phase 1 Intake Service Configuration (Fast ACK Pattern)
# ======================================================================================================================
# Feature gate - enable Phase 1 intake-only fast ACK path
repo.features.phase1.enabled=true
%test.repo.features.phase1.enabled=true

# In-memory state caps
repo.intake.memory.max-uploads=50000
repo.intake.memory.idle-ttl=PT30M

# Progress stream interval
repo.intake.progress.interval=PT0.5S

# Checksum validation (off for Phase 1)
repo.intake.checksum.validate=false

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=repository-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.grpc-stubs.group-id=io.pipeline
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=io.pipeline
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc
