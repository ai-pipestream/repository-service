# Repository Service Configuration
quarkus.application.name=repository
quarkus.application.version=1.0.0-SNAPSHOT

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Repository service port (38102)
quarkus.http.host=0.0.0.0
quarkus.http.port=38102

# HTTP body size limit - 2GB to match gRPC limits for large file uploads
quarkus.http.limits.max-body-size=2G
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# Enable virtual threads for gRPC (JDK 21+) - allows blocking code without stalling IO thread
quarkus.grpc.server.use-virtual-threads=true

# gRPC Flow Control - 50MB window for large messages
quarkus.grpc.server.flow-control-window=52428800

# Set gRPC client flow control for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800

# Dev configuration
%dev.quarkus.http.port=38102
%dev.quarkus.http.root-path=/repository

# Test configuration
%test.quarkus.http.test-port=0

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use PostgreSQL dev service (port 5432)
%dev.quarkus.datasource.jdbc.url=jdbc:postgresql://localhost:5432/repository
%dev.quarkus.datasource.reactive.url=postgresql://localhost:5432/repository

# Hibernate configuration
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true

# Test: Clean database and let Hibernate create schema
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Dev Services - Disable standalone datasource devservices since we're using Compose Dev Services
%dev.quarkus.datasource.devservices.enabled=false

%dev.quarkus.devservices.timeout=120s

# Test profile - use Quarkus DevServices (like connector-admin-service)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.enabled=false

# PostgreSQL via Quarkus DevServices
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.image-name=postgres:16

# MinIO via MinioTestResource (Testcontainers) - configured by @QuarkusTestResource
# Kafka/Apicurio via Quarkus DevServices - added later

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
pipestream.registration.enabled=true
%test.pipestream.registration.enabled=false
pipestream.registration.service-name=repository
pipestream.registration.description=Central repository management for documents, modules, and configurations
pipestream.registration.type=SERVICE
pipestream.registration.capabilities=document-storage,version-control,metadata-management
pipestream.registration.tags=repository,storage,core-service,traefik.enable=true,traefik.http.routers.repository.rule=PathPrefix(`/repository`),traefik.http.routers.repository.entrypoints=web,traefik.http.middlewares.repository-slash.redirectregex.regex=^/repository$$,traefik.http.middlewares.repository-slash.redirectregex.replacement=/repository/,traefik.http.routers.repository.middlewares=repository-slash
# Pipestream server defaults
pipestream.server.class=core
pipestream.server.capabilities=pipedoc

# HTTP Endpoint Registration
pipestream.registration.http.enabled=true
pipestream.registration.http.scheme=${SERVICE_REGISTRATION_HTTP_SCHEME:http}
pipestream.registration.http.base-path=${quarkus.http.root-path:/repository}
pipestream.registration.http.tls-enabled=${SERVICE_REGISTRATION_TLS_ENABLED:false}
pipestream.registration.http.schema=${OPENAPI_SCHEMA_URL}
pipestream.registration.http.schema-version=1.0.0
pipestream.registration.http.schema-artifact-id=repository-service-http

# Production profile - use HTTPS and TLS
%prod.pipestream.registration.http.scheme=https
%prod.pipestream.registration.http.tls-enabled=true

# Stork Consul Self-Registration
# quarkus.stork.repository-service.service-registrar.type=consul
# quarkus.stork.repository-service.service-registrar.consul-host=${CONSUL_HOST:consul}
# quarkus.stork.repository-service.service-registrar.consul-port=${CONSUL_PORT:8500}
# %dev.quarkus.stork.repository-service.service-registrar.consul-host=localhost

# Dynamic gRPC Service Discovery
quarkus.consul.host=${CONSUL_HOST:localhost}
quarkus.consul.port=${CONSUL_PORT:8500}
rokkon.service-discovery.type=consul-direct

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}

# Apicurio Registry configuration (DevServices auto-sets this in dev/test)
%prod.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v3}

# ----- Account Events (Incoming) -----
mp.messaging.incoming.account-events-in.connector=smallrye-kafka
mp.messaging.incoming.account-events-in.topic=account-events

# ----- Repository Events (Outgoing) -----
mp.messaging.outgoing.repository-events-out.connector=smallrye-kafka
mp.messaging.outgoing.repository-events-out.topic=repository-events

# ======================================================================================================================
# S3 / MinIO Configuration (repo-service only)
# ======================================================================================================================
# Disable AWS dev services (LocalStack) - we use MinIO from compose-devservices.yml
%dev.quarkus.s3.devservices.enabled=false
%test.quarkus.s3.devservices.enabled=false

repo.s3.endpoint=${REPO_S3_ENDPOINT:http://localhost:9000}
repo.s3.region=${REPO_S3_REGION:us-east-1}
repo.s3.access-key=${REPO_S3_ACCESS_KEY:minioadmin}
repo.s3.secret-key=${REPO_S3_SECRET_KEY:minioadmin}
repo.s3.bucket=${REPO_S3_BUCKET:pipestream}
repo.s3.path-style-access=${REPO_S3_PATH_STYLE_ACCESS:true}
repo.s3.key-prefix=${REPO_S3_KEY_PREFIX:uploads}

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
quarkus.log.level=INFO
quarkus.log.category."io.pipeline".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN


# ======================================================================================================================
# Phase 1 Intake Service Configuration (Fast ACK Pattern)
# ======================================================================================================================
# Phase 1 intake-only fast ACK path
repo.features.phase1.enabled=true
%test.repo.features.phase1.enabled=true

# Account Validation (can be disabled for dev/test)
repo.account.validation.enabled=true
%dev.repo.account.validation.enabled=true
%test.repo.account.validation.enabled=true

# In-memory state caps
repo.intake.memory.max-uploads=50000
repo.intake.memory.idle-ttl=PT30M

# Progress stream interval
repo.intake.progress.interval=PT0.5S

# Checksum validation (off for Phase 1)
repo.intake.checksum.validate=false

# ======================================================================================================================
# Micrometer/Prometheus Metrics Configuration
# ======================================================================================================================
quarkus.micrometer.binder.http-server.enabled=true
quarkus.micrometer.export.prometheus.enabled=true
quarkus.micrometer.export.prometheus.path=/q/metrics

# ======================================================================================================================
# OpenTelemetry Tracing Configuration
# ======================================================================================================================
quarkus.otel.enabled=true
quarkus.otel.exporter.otlp.endpoint=${OTEL_EXPORTER_OTLP_ENDPOINT:http://localhost:4317}
%dev.quarkus.otel.enabled=false
%test.quarkus.otel.enabled=false

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=io-pipeline
quarkus.container-image.name=repository-service
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# Jandex indexing for third-party and internal dynamic gRPC libraries
quarkus.index-dependency.grpc-stubs.group-id=io.pipeline
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=io.pipeline
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc
