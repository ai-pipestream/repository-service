# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Default HTTP/gRPC configuration
quarkus.http.host=0.0.0.0
quarkus.http.port=38102

# Quinoa UI integration (Vue frontend)

quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
# Enabled by default in dev
quarkus.grpc.server.enable-reflection-service=true
# 2GB - 1 byte (gRPC hard limit)
quarkus.grpc.server.max-inbound-message-size=2147483647

# gRPC Flow Control - 50MB window for large chunks
quarkus.grpc.server.flow-control-window=52428800

# Set gRPC message size limits for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
quarkus.grpc.clients."*".flow-control-window=52428800
#quarkus.grpc.clients."*".max-outbound-message-size=2147483647

# gRPC Client configurations
quarkus.grpc.clients.filesystem-service.host=localhost
quarkus.grpc.clients.filesystem-service.port=38101
quarkus.grpc.clients.pipedoc-service.host=localhost
quarkus.grpc.clients.pipedoc-service.port=38103

# Test: Point gRPC clients to WireMock (port will be injected by DevService)
%test.quarkus.grpc.clients.filesystem-service.host=localhost
%test.quarkus.grpc.clients.filesystem-service.port=${quarkus.wiremock.devservices.port:0}
%test.quarkus.grpc.clients.pipedoc-service.host=localhost
%test.quarkus.grpc.clients.pipedoc-service.port=${quarkus.wiremock.devservices.port:0}

# Dev configuration
%dev.quarkus.http.port=38102
%dev.quarkus.http.host=0.0.0.0
%dev.quarkus.http.root-path=/repository

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false


# ======================================================================================================================
# Apicurio Registry Configuration
# ======================================================================================================================
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka

# ======================================================================================================================
# Kafka Channels
# ======================================================================================================================
mp.messaging.outgoing.repository-events.connector=smallrye-kafka
mp.messaging.outgoing.repository-events.topic=repository-document-events
mp.messaging.outgoing.repository-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.repository-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.repository-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.repository-events.apicurio.registry.artifact-id=repository-document-events-value
mp.messaging.outgoing.repository-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.repository-events.apicurio.registry.proto.message-name=DocumentEvent
mp.messaging.outgoing.repository-events.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.outgoing.repository-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

mp.messaging.outgoing.search-index-events.connector=smallrye-kafka
mp.messaging.outgoing.search-index-events.topic=search-index-events
mp.messaging.outgoing.search-index-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.search-index-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.search-index-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.search-index-events.apicurio.registry.artifact-id=search-index-events-value
mp.messaging.outgoing.search-index-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.search-index-events.apicurio.registry.proto.message-name=SearchIndexEvent
mp.messaging.outgoing.search-index-events.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.outgoing.search-index-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

mp.messaging.outgoing.request-count-events.connector=smallrye-kafka
mp.messaging.outgoing.request-count-events.topic=request-count-events
mp.messaging.outgoing.request-count-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.request-count-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.request-count-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.request-count-events.apicurio.registry.artifact-id=request-count-events-value
mp.messaging.outgoing.request-count-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.request-count-events.apicurio.registry.proto.message-name=RequestCountEvent
mp.messaging.outgoing.request-count-events.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.outgoing.request-count-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
# Datasource configuration
quarkus.datasource.db-kind=mysql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use MySQL dev service (port 3306) - separate database for repo-service
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline_repo_dev

# Hibernate configuration - use current property names
# Dev: Use Flyway migrations
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true

# Test: Clean database and let Hibernate create schema with initial data
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true

# Common settings
quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# General Dev Services
%dev.quarkus.devservices.enabled=true

# Docker Compose Dev Services (Dev Profile)
%dev.quarkus.compose.devservices.files=../../src/test/resources/compose-devservices.yml
%dev.quarkus.devservices.timeout=120s
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true
%dev.quarkus.compose.devservices.stop-timeout=30s
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices


# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

# Test profile uses test compose services (compose-test-services.yml)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=../../src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s

# Test-specific database configuration (must come before devservices config)
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3307/pipeline_repo_test
%test.quarkus.datasource.db-kind=mysql

# Disable automatic MySQL DevServices - we use compose-test-services.yml instead
%test.quarkus.datasource.devservices.enabled=false
# Disable automatic Kafka DevServices - we use compose-test-services.yml instead
%test.quarkus.kafka.devservices.enabled=false

# WireMock DevService configuration for mocking external gRPC services
%test.quarkus.wiremock.devservices.enabled=true
%test.quarkus.wiremock.devservices.extension-scanning-enabled=true
%test.quarkus.wiremock.devservices.files-mapping=classpath:META-INF
%test.quarkus.wiremock.devservices.global-response-templating=true



# Kafka Configuration
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
%dev.kafka.bootstrap.servers=localhost:9094
%test.kafka.bootstrap.servers=localhost:9095
%prod.kafka.bootstrap.servers=kafka:9092

# Global connector defaults for dev so emitters wire cleanly
%dev.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://localhost:8081/apis/registry/v3
%test.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%test.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://localhost:8082/apis/registry/v3

# ======================================================================================================================
# Redis Configuration
# ======================================================================================================================
# Default Redis hosts (can be overridden via env REDIS_HOSTS)
quarkus.redis.hosts=${REDIS_HOSTS:redis://localhost:6379}
%dev.quarkus.redis.hosts=redis://localhost:6379
%test.quarkus.redis.hosts=redis://localhost:6380
%prod.quarkus.redis.hosts=redis://redis:6379

# Dev mode - use MinIO endpoint
%dev.quarkus.s3.devservices.enabled=false
%dev.quarkus.kms.devservices.enabled=false
%dev.quarkus.s3.endpoint-override=http://localhost:9000
%dev.quarkus.s3.aws.region=us-east-1
%dev.quarkus.s3.aws.credentials.type=static
%dev.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%dev.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%dev.quarkus.s3.path-style-access=true
%dev.quarkus.s3.use-arn-region-enabled=false

# Prod mode - Real AWS S3 with IAM
%prod.quarkus.s3.aws.region=${AWS_REGION:us-east-1}
%prod.quarkus.s3.aws.credentials.type=default

# Test mode - uses test MinIO on port 9010
%test.quarkus.s3.devservices.enabled=false
%test.quarkus.kms.devservices.enabled=false
%test.quarkus.s3.endpoint-override=http://localhost:9010
%test.quarkus.s3.aws.region=us-east-1
%test.quarkus.s3.aws.credentials.type=static
%test.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%test.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%test.quarkus.s3.path-style-access=true

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=repository-service
service.registration.description=Document repository service with S3 backend and filesystem management
service.registration.service-type=APPLICATION
service.registration.host=${REPOSITORY_SERVICE_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
service.registration.capabilities=document-storage,filesystem-management,s3-backend,pipedoc-storage
service.registration.tags=repository,storage,filesystem,core-service,traefik.enable=true,traefik.http.routers.repository-service.rule=PathPrefix(`/repository`),traefik.http.routers.repository-service.entrypoints=web,traefik.http.middlewares.repository-slash.redirectregex.regex=^/repository$$,traefik.http.middlewares.repository-slash.redirectregex.replacement=/repository/,traefik.http.routers.repository-service.middlewares=repository-slash
%test.service.registration.enabled=false

# Use service discovery for registration service
pipeline.registration.discovery-name=repository-service
