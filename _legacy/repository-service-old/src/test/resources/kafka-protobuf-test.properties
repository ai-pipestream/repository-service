# Reference configuration for Kafka protobuf messaging
# This file documents the CORRECT way to configure protobuf serialization/deserialization

# ======================================================================================================================
# OUTGOING CHANNEL (Producer) - Sends S3OperationResult with UUID key
# ======================================================================================================================
mp.messaging.outgoing.protobuf-test-out.connector=smallrye-kafka
mp.messaging.outgoing.protobuf-test-out.topic=protobuf-test-topic

# Key serialization - UUID
mp.messaging.outgoing.protobuf-test-out.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer

# Value serialization - Protobuf via Apicurio
mp.messaging.outgoing.protobuf-test-out.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer

# Apicurio Registry configuration for producer
mp.messaging.outgoing.protobuf-test-out.apicurio.registry.url=${apicurio.registry.url:http://localhost:8082/apis/registry/v3}
mp.messaging.outgoing.protobuf-test-out.apicurio.registry.artifact-id=io.pipeline.repository.filesystem.S3OperationResult
mp.messaging.outgoing.protobuf-test-out.apicurio.registry.artifact.group-id=pipeline
mp.messaging.outgoing.protobuf-test-out.apicurio.registry.auto-register=true

# Kafka bootstrap servers
mp.messaging.outgoing.protobuf-test-out.bootstrap.servers=${kafka.bootstrap.servers:localhost:9095}

# ======================================================================================================================
# INCOMING CHANNEL (Consumer) - Receives S3OperationResult with UUID key
# ======================================================================================================================
mp.messaging.incoming.protobuf-test-in.connector=smallrye-kafka
mp.messaging.incoming.protobuf-test-in.topic=protobuf-test-topic

# Key deserialization - UUID
mp.messaging.incoming.protobuf-test-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer

# Value deserialization - Protobuf via Apicurio
mp.messaging.incoming.protobuf-test-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer

# Apicurio Registry configuration for consumer
mp.messaging.incoming.protobuf-test-in.apicurio.registry.url=${apicurio.registry.url:http://localhost:8082/apis/registry/v3}

# ======================================================================================================================
# CRITICAL: YOU MUST SPECIFY THE CONCRETE TYPE FOR DESERIALIZATION
# Without this, you will get DynamicMessage instead of S3OperationResult!
# ======================================================================================================================

# Option 1: Using specific.protobuf.value.type (SmallRye specific)
# mp.messaging.incoming.protobuf-test-in.specific.protobuf.value.type=io.pipeline.repository.filesystem.S3OperationResult

# Option 2: Using apicurio.registry.deserializer.value.return-class (Apicurio specific)
mp.messaging.incoming.protobuf-test-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.S3OperationResult

# Note: Use ONLY ONE of the above options, not both!

# Consumer configuration
mp.messaging.incoming.protobuf-test-in.bootstrap.servers=${kafka.bootstrap.servers:localhost:9095}
mp.messaging.incoming.protobuf-test-in.auto.offset.reset=earliest
mp.messaging.incoming.protobuf-test-in.group.id=protobuf-test-group

# ======================================================================================================================
# COMMON MISTAKES THAT CAUSE DynamicMessage INSTEAD OF CONCRETE TYPE:
# ======================================================================================================================
# 1. Missing specific.protobuf.value.type or apicurio.registry.deserializer.value.return-class
# 2. Using IncomingKafkaRecord<K,V> in @Incoming method (just use the value type directly!)
# 3. Incorrect package name in the type specification
# 4. Missing protobuf generated classes in classpath
# 5. Schema not registered in Apicurio Registry (though auto-register should handle this)
# ======================================================================================================================
