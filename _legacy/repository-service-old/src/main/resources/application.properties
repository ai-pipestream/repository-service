# ======================================================================================================================
# Application Configuration
# ======================================================================================================================
quarkus.application.name=pipedoc-repository-service

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
# Default DB configuration
quarkus.datasource.db-kind=mysql
quarkus.datasource.jdbc.max-size=20

# Dev profile uses compose services, so no explicit URL is needed.
# The db-kind is enough of a hint for Quarkus Dev Services.

# Prod profile requires manual configuration (e.g., via environment variables)
%prod.quarkus.datasource.username=pipeline
%prod.quarkus.datasource.password=password
%prod.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline

# Test profile uses test compose services (compose-test-services.yml)
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3307/pipeline_test

# Note: Test S3 and Kafka configurations are defined later in this file

# ======================================================================================================================
# Hibernate ORM Configuration
# ======================================================================================================================
# For prod, we validate the schema. For dev/test, we drop and create.
# quarkus.hibernate-orm.database.generation=validate

%dev.quarkus.hibernate-orm.log.sql=false
%dev.quarkus.hibernate-orm.log.bind-parameters=false
%dev.quarkus.hibernate-orm.log.format-sql=false
# %test.quarkus.hibernate-orm.database.generation=drop-and-create

# Package scanning for entities
quarkus.hibernate-orm.packages=io.pipeline.repository.model
# Force entity scanning
quarkus.hibernate-orm.physical-naming-strategy=org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy

# Test profile: disable Hibernate schema management (use Flyway migrations)
%test.quarkus.hibernate-orm.database.generation=none

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Default HTTP/gRPC configuration
quarkus.http.host=0.0.0.0
quarkus.http.port=38102
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
# Enabled by default in dev
quarkus.grpc.server.enable-reflection-service=true
# 2GB - 1 byte
quarkus.grpc.server.max-inbound-message-size=2147483647

# Set gRPC message size limits for all clients (wildcard)
quarkus.grpc.clients."*".max-inbound-message-size=2147483647
#quarkus.grpc.clients."*".max-outbound-message-size=2147483647

# Dev configuration
%dev.quarkus.http.port=38102
%dev.quarkus.http.host=0.0.0.0
%dev.quarkus.http.root-path=/repository

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# ======================================================================================================================
# MCP Server (HTTP/SSE) Configuration
# ======================================================================================================================
# Expose MCP endpoint at /mcp and /mcp/sse
quarkus.mcp.server.sse.root-path=/mcp
# Identify server in MCP initialize response
quarkus.server-info.name=${quarkus.application.name}
quarkus.server-info.title=Repository MCP Server
# Enable verbose traffic logging in dev for easier debugging
%dev.quarkus.traffic-logging.enabled=true

# Dev file logging configuration lives in the Logging section below
%dev.quarkus.log.category."io.quarkiverse.mcp.server".level=DEBUG

# ======================================================================================================================
# gRPC Client Configuration
# ======================================================================================================================
# FilesystemService (internal)
# Static gRPC client for opensearch-manager
quarkus.grpc.clients.opensearch.host=opensearch-manager
quarkus.grpc.clients.opensearch.name-resolver=stork

quarkus.grpc.clients.FilesystemService.host=localhost
quarkus.grpc.clients.FilesystemService.port=${quarkus.http.port}
%dev.quarkus.grpc.clients.FilesystemService.port=${quarkus.http.port}
# FilesystemService port is configured dynamically by WireMockGrpcTestResource

# Test gRPC clients
%test.quarkus.grpc.clients.test-pipedoc.host=localhost
%test.quarkus.grpc.clients.test-pipedoc.port=${quarkus.http.test-port}
%test.quarkus.grpc.clients.test-filesystem.host=localhost
%test.quarkus.grpc.clients.test-filesystem.port=${quarkus.http.test-port}

# ======================================================================================================================
# Consul Service Registration & Discovery (Stork)
# ======================================================================================================================
# Default configuration for self-registration
quarkus.stork.pipedoc-repository-service.service-registrar.type=consul
quarkus.stork.pipedoc-repository-service.service-registrar.consul-host=${CONSUL_HOST:consul}
quarkus.stork.pipedoc-repository-service.service-registrar.consul-port=${CONSUL_PORT:8500}

# Dev override - use localhost
%dev.quarkus.stork.pipedoc-repository-service.service-registrar.consul-host=localhost

# Test configuration - use test port for registration
%test.quarkus.stork.pipedoc-repository-service.service-registrar.consul-host=localhost
%test.quarkus.stork.pipedoc-repository-service.service-registrar.consul-port=8510

# Test configuration for service discovery
%test.quarkus.stork.platform-registration-service.service-discovery.type=consul
%test.quarkus.stork.platform-registration-service.service-discovery.consul-host=localhost
%test.quarkus.stork.platform-registration-service.service-discovery.consul-port=8510

# ======================================================================================================================
# Health Check Configuration
# ======================================================================================================================
quarkus.smallrye-health.root-path=/q/health
module.health.check.host=localhost

# ======================================================================================================================
# Kafka S3 Events Channel Configuration
# ======================================================================================================================
mp.messaging.outgoing.s3-events-out.connector=smallrye-kafka
mp.messaging.outgoing.s3-events-out.topic=s3-events
mp.messaging.outgoing.s3-events-out.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.s3-events-out.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.s3-events-out.apicurio.registry.artifact-id=io.pipeline.repository.filesystem.S3OperationResult
mp.messaging.outgoing.s3-events-out.apicurio.registry.artifact.group-id=pipeline
mp.messaging.outgoing.s3-events-out.apicurio.registry.global-id=io.pipeline.repository.filesystem.S3OperationResult
mp.messaging.outgoing.s3-events-out.apicurio.registry.url=http://localhost:8081/apis/registry/v3
mp.messaging.outgoing.s3-events-out.apicurio.registry.auto-register=true
# Serializer is Apicurio v3; no additional specific-type hint needed for outgoing
mp.messaging.outgoing.s3-events-out.bootstrap.servers=localhost:9094
%test.mp.messaging.outgoing.s3-events-out.bootstrap.servers=localhost:9095
%test.mp.messaging.outgoing.s3-events-out.apicurio.registry.url=http://localhost:8082/apis/registry/v3

# ======================================================================================================================
# Kafka S3 Events Incoming Channel Configuration
# ======================================================================================================================
mp.messaging.incoming.s3-events-in.connector=smallrye-kafka
mp.messaging.incoming.s3-events-in.topic=s3-events
mp.messaging.incoming.s3-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.s3-events-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer
mp.messaging.incoming.s3-events-in.bootstrap.servers=localhost:9094
mp.messaging.incoming.s3-events-in.apicurio.registry.url=http://localhost:8081/apis/registry/v3
mp.messaging.incoming.s3-events-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.S3OperationResult
mp.messaging.incoming.s3-events-in.auto.offset.reset=earliest
%test.mp.messaging.incoming.s3-events-in.connector=smallrye-kafka
%test.mp.messaging.incoming.s3-events-in.bootstrap.servers=localhost:9095
%test.mp.messaging.incoming.s3-events-in.apicurio.registry.url=http://localhost:8082/apis/registry/v3

# ======================================================================================================================
# S3 Thread Pool Configuration
# ======================================================================================================================
# Dedicated thread pool for S3 operations to prevent blocking Vert.x event loop
s3.thread-pool.core-size=10
s3.thread-pool.max-size=50
s3.thread-pool.queue-size=100
s3.thread-pool.keep-alive-seconds=60

# ======================================================================================================================
# S3 Cleanup Service Configuration
# ======================================================================================================================
# Delay before scheduled jobs start (seconds) - allows DB schema creation
s3.cleanup.startup.delay=30
# Cleanup intervals
s3.cleanup.deleted.nodes.interval=5m
s3.cleanup.failed.uploads.interval=10m
s3.cleanup.hard.delete.cron=0 0 2 * * ?

# ======================================================================================================================
# KMS Configuration
# ======================================================================================================================
# KMS configuration for encryption
quarkus.kms.master-key-arn=
quarkus.kms.endpoint-override=
quarkus.kms.aws.region=us-east-1
quarkus.kms.aws.credentials.type=default

# Dev mode - use local KMS (LocalStack)
%dev.quarkus.kms.endpoint-override=http://localhost:4566
%dev.quarkus.kms.aws.region=us-east-1
%dev.quarkus.kms.aws.credentials.type=static
%dev.quarkus.kms.aws.credentials.static-provider.access-key-id=test-key
%dev.quarkus.kms.aws.credentials.static-provider.secret-access-key=test-secret

# Repository encryption settings
repository.encryption.use-kms=false
repository.encryption.key=default-encryption-key-32-chars-long

# ======================================================================================================================
# S3 / MinIO Configuration
# ======================================================================================================================
# Default S3 configuration
pipeline.repository.s3.bucket=pipeline-repository
pipeline.repository.s3.prefix=filesystem

# Dev mode - use MinIO endpoint
%dev.quarkus.s3.endpoint-override=http://localhost:9000
%dev.quarkus.s3.aws.region=us-east-1
%dev.quarkus.s3.aws.credentials.type=static
%dev.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%dev.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%dev.quarkus.s3.path-style-access=true
%dev.quarkus.s3.use-arn-region-enabled=false

# Prod mode - Real AWS S3 with IAM
%prod.quarkus.s3.aws.region=${AWS_REGION:us-east-1}
%prod.quarkus.s3.aws.credentials.type=default

# Test mode - uses test MinIO on port 9010
%test.quarkus.s3.endpoint-override=http://localhost:9010
%test.quarkus.s3.aws.region=us-east-1
%test.quarkus.s3.aws.credentials.type=static
%test.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%test.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%test.quarkus.s3.path-style-access=true

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
# Default Kafka bootstrap servers
kafka.bootstrap.servers=localhost:9094

# Dev configuration
%dev.kafka.bootstrap.servers=localhost:9094

# Test configuration (consolidated above)

# ======================================================================================================================
# Kafka Messaging Configuration
# ======================================================================================================================
# Global Apicurio Registry Configuration
apicurio.registry.url=http://localhost:8081/apis/registry/v3


# ======================================================================================================================
# Kafka Messaging - Repository Events (New gRPC Event Types)
# ======================================================================================================================
# Drive Events Channel
mp.messaging.outgoing.drive-events.connector=smallrye-kafka
mp.messaging.outgoing.drive-events.topic=drive-events
mp.messaging.outgoing.drive-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.drive-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.drive-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.drive-events.apicurio.registry.artifact-id=drive-events-value
mp.messaging.outgoing.drive-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.drive-events.apicurio.registry.proto.message-name=DriveEvent
mp.messaging.outgoing.drive-events.bootstrap.servers=localhost:9094
%dev.mp.messaging.outgoing.drive-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# Document Events Channel
mp.messaging.outgoing.document-events.connector=smallrye-kafka
mp.messaging.outgoing.document-events.topic=document-events
mp.messaging.outgoing.document-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.document-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.document-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.document-events.apicurio.registry.artifact-id=document-events-value
mp.messaging.outgoing.document-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.document-events.apicurio.registry.proto.message-name=DocumentEvent
mp.messaging.outgoing.document-events.bootstrap.servers=localhost:9094
%dev.mp.messaging.outgoing.document-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# Search Index Events Channel
mp.messaging.outgoing.search-index-events.connector=smallrye-kafka
mp.messaging.outgoing.search-index-events.topic=search-index-events
mp.messaging.outgoing.search-index-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.search-index-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.search-index-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.search-index-events.apicurio.registry.artifact-id=search-index-events-value
mp.messaging.outgoing.search-index-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.search-index-events.apicurio.registry.proto.message-name=SearchIndexEvent
mp.messaging.outgoing.search-index-events.bootstrap.servers=localhost:9094
%dev.mp.messaging.outgoing.search-index-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# Request Count Events Channel
mp.messaging.outgoing.request-count-events.connector=smallrye-kafka
mp.messaging.outgoing.request-count-events.topic=request-count-events
mp.messaging.outgoing.request-count-events.value.serializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaSerializer
mp.messaging.outgoing.request-count-events.key.serializer=org.apache.kafka.common.serialization.UUIDSerializer
mp.messaging.outgoing.request-count-events.apicurio.registry.auto-register=true
mp.messaging.outgoing.request-count-events.apicurio.registry.artifact-id=request-count-events-value
mp.messaging.outgoing.request-count-events.apicurio.registry.artifact-type=PROTOBUF
mp.messaging.outgoing.request-count-events.apicurio.registry.proto.message-name=RequestCountEvent
mp.messaging.outgoing.request-count-events.bootstrap.servers=localhost:9094
%dev.mp.messaging.outgoing.request-count-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# ======================================================================================================================
# Legacy Kafka Messaging Channels (Deprecated - Use new event channels above)
# ======================================================================================================================
# These channels are kept for backward compatibility but should be migrated to the new event system

# ======================================================================================================================
# Legacy Kafka Messaging - Incoming Channels (Deprecated)
# ======================================================================================================================
# These channels are kept for backward compatibility but should be migrated to the new event system

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# General Dev Services
%dev.quarkus.devservices.enabled=true

# Docker Compose Dev Services (Dev Profile)
%dev.quarkus.compose.devservices.files=../../src/test/resources/compose-devservices.yml
%dev.quarkus.devservices.timeout=120s
%dev.quarkus.compose.devservices.start-services=false
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices

# Kafka Dev Services
%dev.quarkus.kafka.devservices.enabled=true

# Global connector defaults for dev so emitters wire cleanly
%dev.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# S3 init tweaks for faster dev reloads
%dev.pipeline.repository.s3.init-bucket=true

# Test Compose Dev Services (Test Profile) â€” can be enabled later with a test-specific compose file

# ======================================================================================================================
# Logging Configuration
# ======================================================================================================================
# Default logging configuration
quarkus.log.level=INFO
quarkus.log.category."io.pipeline".level=INFO
quarkus.log.category."io.vertx.ext.consul".level=WARN
quarkus.log.category."io.quarkus.grpc".level=WARN
# Suppress harmless warnings
quarkus.log.category."io.quarkus.arc.processor.IndexClassLookupUtils".level=ERROR
quarkus.log.category."io.quarkus.arc.deployment.SplitPackageProcessor".level=ERROR

# Dev logging (less verbose)
%dev.quarkus.log.console.level=INFO
%dev.quarkus.log.category."io.pipeline".level=INFO
%dev.quarkus.log.file.enabled=true
%dev.quarkus.log.file.path=logs/repository-service.log
%dev.quarkus.log.file.level=INFO
%dev.quarkus.log.file.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) %s%e%n
%dev.quarkus.log.file.rotation.max-file-size=10M
%dev.quarkus.log.file.rotation.max-backup-index=10

# Reduce noise from dependency categories
%dev.quarkus.log.category."io.pipeline.dynamic.grpc".level=WARN
%dev.quarkus.log.category."io.pipeline.dynamic.grpc.client".level=WARN
%dev.quarkus.log.category."io.smallrye.stork".level=WARN
%dev.quarkus.log.category."io.smallrye.stork.impl".level=WARN
%dev.quarkus.log.category."io.vertx.ext.consul".level=WARN
%dev.quarkus.log.category."io.quarkus.grpc".level=WARN
%dev.quarkus.log.category."io.grpc".level=WARN
%dev.quarkus.log.category."io.smallrye.mutiny".level=WARN

# Test logging
%test.quarkus.log.category."io.pipeline.repository".level=DEBUG
%test.quarkus.log.console.enable=true

# Reduce noise for expected issues during test shutdown
%test.quarkus.log.category."org.hibernate.engine.jdbc.spi.SqlExceptionHelper".level=WARN
%test.quarkus.log.category."io.grpc".level=WARN
%test.quarkus.log.category."io.netty".level=WARN
%test.quarkus.log.category."io.pipeline.dynamic.grpc.client.DynamicGrpcClientFactory".level=WARN

# Test configuration consolidated below

# ======================================================================================================================
# Micrometer (Dev-only cleanups)
# ======================================================================================================================
# Disable HTTP server binder in dev to avoid high-cardinality URI tag warnings
%dev.quarkus.micrometer.binder.http-server.enabled=false
# Silence duplicate meter registration noise during hot reloads
%dev.quarkus.log.category."io.micrometer.core.instrument.MeterRegistry".level=ERROR
%dev.quarkus.log.category."io.micrometer.core.instrument.internal.OnlyOnceLoggingDenyMeterFilter".level=ERROR

# ======================================================================================================================
# Dynamic gRPC Channel Management Configuration
# ======================================================================================================================
# Production/default settings - conservative to prevent resource leaks
pipeline.grpc.channel.idle-ttl-minutes=15
pipeline.grpc.channel.max-size=1000
pipeline.grpc.channel.shutdown-timeout-seconds=2

# Development settings - more aggressive cleanup for faster iteration
%dev.pipeline.grpc.channel.idle-ttl-minutes=5
%dev.pipeline.grpc.channel.max-size=100
%dev.pipeline.grpc.channel.shutdown-timeout-seconds=1

# Test settings - minimal resources and fast cleanup
%test.pipeline.grpc.channel.idle-ttl-minutes=1
%test.pipeline.grpc.channel.max-size=10
%test.pipeline.grpc.channel.shutdown-timeout-seconds=1

# Consul configuration for dynamic discovery
# Stork configuration for opensearch-manager
quarkus.stork.opensearch-manager.service-discovery.type=consul
quarkus.stork.opensearch-manager.service-discovery.consul-host=localhost
quarkus.stork.opensearch-manager.service-discovery.consul-port=8500
quarkus.stork.opensearch-manager.service-discovery.application=opensearch-manager
quarkus.stork.opensearch-manager.service-discovery.use-health-checks=true

pipeline.consul.host=localhost
pipeline.consul.port=8500
pipeline.consul.refresh-period=10s
pipeline.consul.use-health-checks=true

# Override for specific environments
%dev.pipeline.consul.refresh-period=5s
%test.pipeline.consul.refresh-period=30s

# ======================================================================================================================
# Service Registration (Platform)
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=repository-service
service.registration.description=Document repository service with S3 backend and search capabilities
service.registration.service-type=APPLICATION
service.registration.port=${quarkus.http.port}
service.registration.capabilities=document-storage,document-search,metadata-management,s3-backend
service.registration.tags=repository,storage,search

# Use service discovery for registration service - correct property name
pipeline.registration.discovery-name=repository-service


# Test configuration consolidated below

# ======================================================================================================================
# Cache Configuration
# ======================================================================================================================
# Graph cache
graph.cache.refresh.enabled=true
graph.cache.refresh.interval=5m

# Graph cache refresh configuration
# Enable in production, disable in dev/test to avoid timing issues

# Module cache
module.cache.refresh.enabled=true
module.cache.refresh.interval=5m
%dev.module.cache.refresh.enabled=false

# Test configuration consolidated below

# ======================================================================================================================
# Redis Configuration (for tests)
# ======================================================================================================================
%test.pipeline.repository.redis.root-prefix=pipeline:test:
%test.pipeline.repository.redis.filesystem-prefix=fs:
%test.pipeline.repository.redis.pipedoc-prefix=pipedoc:
%test.pipeline.repository.redis.request-prefix=request:

# ======================================================================================================================
# Jandex Indexing
# ======================================================================================================================
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka
quarkus.index-dependency.apicurio-common.group-id=io.apicurio
quarkus.index-dependency.apicurio-common.artifact-id=apicurio-registry-common
quarkus.index-dependency.apicurio-serde-common.group-id=io.apicurio
quarkus.index-dependency.apicurio-serde-common.artifact-id=apicurio-registry-serde-common
quarkus.index-dependency.apicurio-java-sdk.group-id=io.apicurio
quarkus.index-dependency.apicurio-java-sdk.artifact-id=apicurio-registry-java-sdk

# Ensure dev-mode classloader can resolve protobuf stubs
quarkus.index-dependency.grpc-stubs.group-id=io.pipeline
quarkus.index-dependency.grpc-stubs.artifact-id=grpc-stubs
quarkus.index-dependency.dynamic-grpc.group-id=io.pipeline
quarkus.index-dependency.dynamic-grpc.artifact-id=dynamic-grpc

# ======================================================================================================================
# Quinoa Configuration (Vue.js UI) - DISABLED FOR NOW
# ======================================================================================================================

# ======================================================================================================================
# Container Image Configuration
# ======================================================================================================================
quarkus.container-image.build=false

# ======================================================================================================================
# Hibernate JSON Format Mapper Warning Mitigation
# ======================================================================================================================
# Our ObjectMapper is customized (e.g., Apicurio and timestamps). Use DB-agnostic mapping for JSON columns.
quarkus.hibernate-orm.mapping.format.global=ignore
quarkus.container-image.name=pipedoc-repository-service
quarkus.container-image.tag=latest
quarkus.container-image.registry=localhost:5000
quarkus.container-image.insecure=true

# ======================================================================================================================
# Kubernetes Configuration
# ======================================================================================================================
# Not using Kubernetes deployment currently
# quarkus.kubernetes.deployment-target=docker

# ======================================================================================================================
# Miscellaneous
# ======================================================================================================================
# Module auto-registration
module.auto-register.enabled=false

# CORS
quarkus.http.cors=true
quarkus.http.cors.origins=/.*/

# Flatten test classpath to avoid duplicate classes across classloaders
%test.quarkus.test.flat-class-path=true

# ======================================================================================================================
# Test Configuration - Unit Test Setup
# ======================================================================================================================
# Use real Kafka + Apicurio for all messaging channels in tests for protobuf validation
# Test services: Kafka (localhost:9095) + Apicurio Registry (localhost:8082)
# This ensures proper protobuf schema validation during testing

# Enable MySQL dev services for automatic test database
%test.quarkus.datasource.devservices.enabled=true
%test.quarkus.datasource.devservices.show-logs=false
# Create isolated databases per test class
%test.quarkus.datasource.devservices.db-name=testdb_${quarkus.test.class-suffix:default}
# Reuse containers for faster tests but with different databases
%test.quarkus.datasource.devservices.reuse=true

# Disable compose and kafka dev services for unit tests (we want in-memory services)
%test.quarkus.compose.devservices.enabled=false
%test.quarkus.kafka.devservices.enabled=false

# Fast hibernate settings for testing
%test.quarkus.hibernate-orm.log.sql=false

# Configure gRPC clients to use WireMock during tests
# FilesystemService is the main external dependency we need to mock
%test.quarkus.grpc.clients.FilesystemService.host=127.0.0.1
%test.quarkus.grpc.clients.FilesystemService.port=${quarkus.http.test-port}
%test.quarkus.grpc.clients.FilesystemService.use-plain-text=true
%test.quarkus.grpc.clients.FilesystemService.negotiation-type=PLAINTEXT

# Test configuration for OpenSearch Manager discovery
%test.quarkus.stork.opensearch-manager.service-discovery.type=consul
%test.quarkus.stork.opensearch-manager.service-discovery.consul-host=localhost
%test.quarkus.stork.opensearch-manager.service-discovery.consul-port=8510

# Test-specific Kafka and Apicurio configuration
%test.kafka.bootstrap.servers=localhost:9095
%test.apicurio.registry.url=http://localhost:8082/apis/registry/v3

# Test-specific Kafka messaging channels
%test.mp.messaging.outgoing.drive-events.topic=drive-events-test
%test.mp.messaging.outgoing.document-events.topic=document-events-test
%test.mp.messaging.outgoing.search-index-events.topic=search-index-events-test
%test.mp.messaging.outgoing.request-count-events.topic=request-count-events-test

%test.mp.messaging.outgoing.drive-events.bootstrap.servers=localhost:9095
%test.mp.messaging.outgoing.drive-events.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.outgoing.document-events.bootstrap.servers=localhost:9095
%test.mp.messaging.outgoing.document-events.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.outgoing.search-index-events.bootstrap.servers=localhost:9095
%test.mp.messaging.outgoing.search-index-events.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.outgoing.request-count-events.bootstrap.servers=localhost:9095
%test.mp.messaging.outgoing.request-count-events.apicurio.registry.url=http://localhost:8082/apis/registry/v3

# Test-specific incoming channels
%test.mp.messaging.incoming.drive-events-in.topic=drive-events-test
%test.mp.messaging.incoming.document-events-in.topic=document-events-test
%test.mp.messaging.incoming.search-index-events-in.topic=search-index-events-test
%test.mp.messaging.incoming.request-count-events-in.topic=request-count-events-test

%test.mp.messaging.incoming.drive-events-in.bootstrap.servers=localhost:9095
%test.mp.messaging.incoming.drive-events-in.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.incoming.drive-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
%test.mp.messaging.incoming.drive-events-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer
%test.mp.messaging.incoming.drive-events-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.DriveEvent
%test.mp.messaging.incoming.drive-events-in.auto.offset.reset=earliest

%test.mp.messaging.incoming.document-events-in.bootstrap.servers=localhost:9095
%test.mp.messaging.incoming.document-events-in.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.incoming.document-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
%test.mp.messaging.incoming.document-events-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer
%test.mp.messaging.incoming.document-events-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.DocumentEvent
%test.mp.messaging.incoming.document-events-in.auto.offset.reset=earliest

%test.mp.messaging.incoming.search-index-events-in.bootstrap.servers=localhost:9095
%test.mp.messaging.incoming.search-index-events-in.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.incoming.search-index-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
%test.mp.messaging.incoming.search-index-events-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer
%test.mp.messaging.incoming.search-index-events-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.SearchIndexEvent
%test.mp.messaging.incoming.search-index-events-in.auto.offset.reset=earliest

%test.mp.messaging.incoming.request-count-events-in.bootstrap.servers=localhost:9095
%test.mp.messaging.incoming.request-count-events-in.apicurio.registry.url=http://localhost:8082/apis/registry/v3
%test.mp.messaging.incoming.request-count-events-in.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
%test.mp.messaging.incoming.request-count-events-in.key.deserializer=org.apache.kafka.common.serialization.UUIDDeserializer
%test.mp.messaging.incoming.request-count-events-in.apicurio.registry.deserializer.value.return-class=io.pipeline.repository.filesystem.RequestCountEvent
%test.mp.messaging.incoming.request-count-events-in.auto.offset.reset=earliest

# Test-specific service configuration
%test.service.registration.enabled=false
%test.module.registration.enabled=false
%test.pipeline.registration.auto-register=false
%test.quarkus.scheduler.enabled=false
%test.quarkus.hibernate-orm.sql-load-script=no-file

# Test logging
%test.quarkus.log.level=INFO
%test.quarkus.log.category."io.pipeline.repository.kafka".level=DEBUG
%test.quarkus.log.category."io.apicurio.registry".level=DEBUG

# Dev default drives (auto-created)
%dev.pipeline.repository.default-drives=pipedocs-drive,process-requests-drive,process-responses-drive,graph-nodes-drive,modules-drive

# S3 bucket auto-create policy (dev only); prod stays false by default
repository.s3.auto-create-buckets=false
%dev.repository.s3.auto-create-buckets=true

# Hibernate ORM schema management (replaces deprecated database.generation)
quarkus.hibernate-orm.schema-management.strategy=validate
%dev.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%it.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
